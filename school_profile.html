<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="stylesschool.css">

    <title>Iskol√°k List√°ja</title>
   
</head>
<body>
    <div class="container">
        <button id="dark-mode-toggle">üåô</button>
        <h2>Versenyz≈ëk/iskol√°k kilist√°z√°sa</h2>
        <table id="schools-table">
            <thead>
                <tr>
                    <th>Iskola neve</th>
                    <th>Csapat neve</th>
                    <th>St√°tusz</th>
                    <th>R√©szletek</th>
                    <th>M≈±veletek</th>
                </tr>
            </thead>
            <tbody id="schools-body">
            </tbody>
        </table>
        <div id="message"></div>
        <br>
        <form action="logoutadmin.php" method="post">
            <button type="submit">Kijelentkez√©s</button>
        </form>
    </div>

    <!-- T√∂rl√©s meger≈ës√≠t≈ë dial√≥gus -->
<div class="overlay" id="deleteOverlay"></div>
<div class="confirmation-dialog" id="deleteConfirmation">
    <h3>Meger≈ës√≠t√©s</h3>
    <br>
    <p>Biztosan t√∂r√∂lni szeretn√© ezt a jelentkez√©st?</p>
    <br>
    <button id="confirmDelete" class="delete-btn">T√∂rl√©s</button>
    <button id="cancelDelete">M√©gse</button>
</div>

<!-- Elfogad√°s meger≈ës√≠t≈ë dial√≥gus -->
<div class="overlay" id="approveOverlay"></div>
<div class="confirmation-dialog" id="approveConfirmation">
    <h3>Meger≈ës√≠t√©s</h3>
    <br>
    <p>Biztosan elfogadja ezt a jelentkez√©st?</p>
    <br>
    <button id="confirmApprove" class="approve-btn">Elfogad√°s</button>
    <button id="cancelApprove">M√©gse</button>
</div>

<!-- Visszautas√≠t√°s meger≈ës√≠t≈ë dial√≥gus -->
<div class="overlay" id="rejectOverlay"></div>
<div class="confirmation-dialog" id="rejectConfirmation">
    <h3>Meger≈ës√≠t√©s</h3>
    <br>
    <p>Biztosan visszautas√≠tja ezt a jelentkez√©st?</p>
    <br>
    <button id="confirmReject" class="reject-btn">Visszautas√≠t√°s</button>
    <button id="cancelReject">M√©gse</button>

</div>


    <script src="dark-mode.js"></script>
    <script src="localstorage.js"></script>
<script>



    document.addEventListener("DOMContentLoaded", function() {
        let currentActionId = null;
        
        // Overlay √©s dial√≥gus elemek
        const deleteOverlay = document.getElementById('deleteOverlay');
        const approveOverlay = document.getElementById('approveOverlay');
        const rejectOverlay = document.getElementById('rejectOverlay');
        
        const deleteConfirmation = document.getElementById('deleteConfirmation');
        const approveConfirmation = document.getElementById('approveConfirmation');
        const rejectConfirmation = document.getElementById('rejectConfirmation');
        
        // Meger≈ës√≠t≈ë √©s megszak√≠t√≥ gombok
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const confirmApproveBtn = document.getElementById('confirmApprove');
        const confirmRejectBtn = document.getElementById('confirmReject');
        
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const cancelApproveBtn = document.getElementById('cancelApprove');
        const cancelRejectBtn = document.getElementById('cancelReject');

        // Dial√≥gus megjelen√≠t≈ë f√ºggv√©nyek
        function showDeleteConfirmation(id) {
            currentActionId = id;
            deleteOverlay.style.display = 'block';
            deleteConfirmation.style.display = 'block';
        }

        function showApproveConfirmation(id) {
            currentActionId = id;
            approveOverlay.style.display = 'block';
            approveConfirmation.style.display = 'block';
        }

        function showRejectConfirmation(id) {
            currentActionId = id;
            rejectOverlay.style.display = 'block';
            rejectConfirmation.style.display = 'block';
        }

        // Dial√≥gus elrejt≈ë f√ºggv√©nyek
        function hideDeleteConfirmation() {
            deleteOverlay.style.display = 'none';
            deleteConfirmation.style.display = 'none';
            currentActionId = null;
        }

        function hideApproveConfirmation() {
            approveOverlay.style.display = 'none';
            approveConfirmation.style.display = 'none';
            currentActionId = null;
        }

        function hideRejectConfirmation() {
            rejectOverlay.style.display = 'none';
            rejectConfirmation.style.display = 'none';
            currentActionId = null;
        }

        // M≈±veletek v√©grehajt√°sa
        async function deleteApplication(id) {
            try {
                const response = await fetch('delete_application.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.remove();
                    }
                    
                    showMessage("Sikeres t√∂rl√©s!", "success");
                    
                } else {
                    showMessage(result.message || "Hiba t√∂rt√©nt a t√∂rl√©s sor√°n.", "error");
                }
            } catch (error) {
                console.error("Hiba t√∂rt√©nt a t√∂rl√©s sor√°n:", error);
                showMessage("Hiba t√∂rt√©nt a t√∂rl√©s sor√°n.", "error");
            }
        }

        async function updateApplicationStatus(id, status) {
            try {
                const response = await fetch('update_status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id, status: status })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.className = status;
                        const statusCell = row.querySelector('.status-badge');
                        statusCell.textContent = getStatusText(status);
                        statusCell.className = `status-badge status-${status}`;
                    }
                    showMessage(`Jelentkez√©s ${getStatusText(status).toLowerCase()}!`, "success");
                    location.reload(); // Oldal √∫jrat√∂lt√©se a friss sorrend√©rt
                } else {
                    showMessage(result.message || "Hiba t√∂rt√©nt a st√°tusz m√≥dos√≠t√°sa sor√°n.", "error");
                }
            } catch (error) {
                console.error("Hiba t√∂rt√©nt a st√°tusz m√≥dos√≠t√°sa sor√°n:", error);
                showMessage("Hiba t√∂rt√©nt a st√°tusz m√≥dos√≠t√°sa sor√°n.", "error");
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'approved': return 'Elfogadva';
                case 'rejected': return 'Visszautas√≠tva';
                default: return 'F√ºgg≈ëben';
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById("message");
            messageDiv.innerText = message;
            messageDiv.style.color = type === "success" ? "green" : "red";
        }

        // Esem√©nykezel≈ëk
        confirmDeleteBtn.addEventListener('click', () => {
            if (currentActionId) {
                deleteApplication(currentActionId);
                hideDeleteConfirmation();
            }
        });

        confirmApproveBtn.addEventListener('click', () => {
            if (currentActionId) {
                updateApplicationStatus(currentActionId, 'approved');
                hideApproveConfirmation();
            }
        });

        confirmRejectBtn.addEventListener('click', () => {
            if (currentActionId) {
                updateApplicationStatus(currentActionId, 'rejected');
                hideRejectConfirmation();
            }
        });

        // Megszak√≠t√≥ gombok esem√©nykezel≈ëi
        cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);
        cancelApproveBtn.addEventListener('click', hideApproveConfirmation);
        cancelRejectBtn.addEventListener('click', hideRejectConfirmation);

        // Overlay kattint√°s esem√©nykezel≈ëk
        deleteOverlay.addEventListener('click', hideDeleteConfirmation);
        approveOverlay.addEventListener('click', hideApproveConfirmation);
        rejectOverlay.addEventListener('click', hideRejectConfirmation);

        // Adatok bet√∂lt√©se
        fetch("get_schools.php", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tableBody = document.getElementById("schools-body");
                tableBody.innerHTML = "";
                
                data.data.forEach(application => {
                    const row = document.createElement("tr");
                    row.setAttribute('data-id', application.id);
                    row.className = application.status || 'pending';
                    
                    row.innerHTML = `
                        <td>${application.school_name}</td>
                        <td>${application.team_name}</td>
                        <td><span class="status-badge status-${application.status || 'pending'}">${getStatusText(application.status)}</span></td>
                        <td>
                            <details>
                                <summary>R√©szletek</summary>
                                <div class="details-content">
                                    <p>Els≈ë tag: ${application.team_member1_name}, Oszt√°ly: ${application.team_member1_grade}</p>
                                    <p>M√°sodik tag: ${application.team_member2_name}, Oszt√°ly: ${application.team_member2_grade}</p>
                                    <p>Harmadik tag: ${application.team_member3_name}, Oszt√°ly: ${application.team_member3_grade}</p>
                                    <p>P√≥t tag: ${application.substitute_member_name}, Oszt√°ly: ${application.substitute_member_grade}</p>
                                    <p>Felk√©sz√≠t≈ë tan√°r: ${application.teacher}</p>
                                    <p>Kateg√≥ria: ${application.category}</p>
                                    <p>Programnyelv: ${application.programming_language}</p>
                                </div>
                            </details>
                        </td>
                        <td class="action-buttons">
                            <button class="approve-btn" onclick="showApproveConfirmation('${application.id}')">
                                Elfogad√°s
                            </button>
                            <button class="reject-btn" onclick="showRejectConfirmation('${application.id}')">
                                Visszautas√≠t√°s
                            </button>
                            <button class="delete-btn" onclick="showDeleteConfirmation('${application.id}')">
                                T√∂rl√©s
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                showMessage(data.message || "Nincsenek adatok el√©rhet≈ëek.", "error");
            }
        })
        .catch(error => {
            console.error("Hiba t√∂rt√©nt a lek√©r√©s sor√°n:", error);
            showMessage("Hiba t√∂rt√©nt a lek√©r√©s sor√°n.", "error");
        });

        // Glob√°lis f√ºggv√©nyek
        window.showDeleteConfirmation = showDeleteConfirmation;
        window.showApproveConfirmation = showApproveConfirmation;
        window.showRejectConfirmation = showRejectConfirmation;
    });
</script>
</body>
</html>